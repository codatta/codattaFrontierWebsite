<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Codatta - Knob Annotation Task</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: radial-gradient(ellipse at top, #1a0a2e 0%, #0a0a0a 50%);
        background-attachment: fixed;
        color: #ffffff;
        min-height: 100vh;
        position: relative;
        padding: 24px 48px;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 1380px;
        margin: 0 auto;
        padding: 0 24px 40px;
        position: relative;
        z-index: 1;
      }

      .app-header {
        margin-bottom: 20px;
        text-align: center;
      }

      .title-main {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #a78bfa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
      }

      .title-sub {
        font-size: 15px;
        color: #a0a0a0;
      }

      .guidelines-section {
        margin-top: 16px;
        margin-bottom: 20px;
        text-align: left;
      }

      .guidelines-title {
        font-size: 15px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 10px;
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .guidelines-title::before {
        content: '';
        width: 3px;
        height: 14px;
        background: linear-gradient(135deg, #6366f1, #22c1c3);
        border-radius: 999px;
      }

      .guidelines-subsection {
        margin-bottom: 12px;
      }

      .guidelines-subsection:last-child {
        margin-bottom: 0;
      }

      .guidelines-subtitle {
        font-size: 12px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 10px;
      }

      .guidelines-text {
        font-size: 13px;
        line-height: 1.6;
        color: #d0d0d0;
      }

      .guidelines-subsection .requirements-list {
        margin-top: 8px;
      }

      .guidelines-subsection .requirements-list li {
        color: #d1d5db;
        font-size: 13px;
        padding: 4px 0;
        padding-left: 24px;
        position: relative;
      }

      .guidelines-subsection .requirements-list li::before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: #10b981;
        font-weight: 700;
      }

      .main-layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 20px;
        margin-bottom: 32px;
        align-items: start;
      }

      @media (max-width: 1200px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 1200px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
      }

      .steps-panel {
        position: sticky;
        top: 24px;
        align-self: start;
      }

      .work-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .main-panel {
        background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
      }

      .main-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #8b5cf6, #667eea, #8b5cf6);
        background-size: 200% 100%;
        animation: shimmer 3s linear infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .sidebar-panel {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .info-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
        border-radius: 20px;
        padding: 20px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        backdrop-filter: blur(10px);
      }

      .section-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-title::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 2px;
      }

      /* Steps */
      .steps-container {
        margin-top: 24px;
        margin-bottom: 24px;
      }

      .step {
        background: rgba(139, 92, 246, 0.08);
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 8px;
        border: 1px solid rgba(139, 92, 246, 0.2);
        transition: all 0.3s;
      }

      .step.active {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      }

      .step.completed {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6, #667eea);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
      }

      .step.completed .step-number {
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }

      .step-title {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
      }

      .step-content {
        margin-left: 44px;
        color: #d0d0d0;
        font-size: 13px;
        line-height: 1.5;
      }

      /* Upload Area */
      .upload-area {
        border: 2px dashed rgba(139, 92, 246, 0.4);
        border-radius: 8px;
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(139, 92, 246, 0.05);
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .upload-area:hover {
        border-color: rgba(139, 92, 246, 0.6);
        background: rgba(139, 92, 246, 0.1);
      }

      .upload-area.has-image {
        display: none;
      }

      .upload-status {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .upload-area.has-image .upload-status {
        display: flex;
      }

      .upload-area.has-image .upload-icon,
      .upload-area.has-image .upload-text,
      .upload-area.has-image .upload-hint {
        display: none;
      }

      .upload-file-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
      }

      .upload-file-icon {
        font-size: 24px;
      }

      .upload-file-name {
        color: #22c55e;
        font-size: 14px;
        font-weight: 600;
      }

      .btn-delete {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.4);
        padding: 8px 16px;
      }

      .btn-delete:hover {
        background: rgba(239, 68, 68, 0.3);
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .upload-text {
        color: #a78bfa;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .upload-hint {
        color: #888888;
        font-size: 13px;
      }

      #imageInput {
        display: none;
      }

      /* Canvas Container */
      .canvas-container {
        position: relative;
        width: 100%;
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        background: #000000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #annotationCanvas {
        display: block;
        cursor: crosshair;
      }

      .canvas-controls {
        margin-top: 16px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #8b5cf6, #667eea);
        color: #ffffff;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
      }

      .btn-secondary {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
        border: 1px solid rgba(139, 92, 246, 0.4);
      }

      .btn-secondary:hover {
        background: rgba(139, 92, 246, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #ffffff;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Coordinates Display */
      .coordinates-display {
        margin-top: 16px;
        padding: 16px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .coordinate-item {
        margin-bottom: 12px;
        font-size: 14px;
      }

      .coordinate-item:last-child {
        margin-bottom: 0;
      }

      .coordinate-label {
        color: #a78bfa;
        font-weight: 600;
        margin-right: 8px;
      }

      .coordinate-value {
        color: #ffffff;
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 4px 8px;
        border-radius: 4px;
      }

      /* Input Field */
      .input-group {
        margin-top: 16px;
      }

      .input-label {
        display: block;
        color: #a78bfa;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .input-field {
        width: 100%;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        color: #ffffff;
        font-size: 14px;
        transition: all 0.3s;
      }

      .input-field:focus {
        outline: none;
        border-color: rgba(139, 92, 246, 0.6);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      /* Requirements List */
      .requirements-list {
        list-style: none;
        padding: 0;
      }

      .requirements-list li {
        padding: 8px 0;
        padding-left: 24px;
        position: relative;
        color: #d0d0d0;
        font-size: 14px;
        line-height: 1.6;
      }

      .requirements-list li::before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: #22c55e;
        font-weight: bold;
      }

      /* Example Images */
      .example-images {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 16px;
      }

      .example-image-item {
        text-align: center;
      }

      .example-image-item img {
        max-width: 100%;
        border-radius: 8px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        margin-bottom: 8px;
      }

      .example-image-label {
        font-size: 12px;
        color: #888888;
      }

      /* Status Messages */
      .status-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 14px;
        display: none;
      }

      .status-message.success {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #22c55e;
        display: block;
      }

      .status-message.error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #ef4444;
        display: block;
      }

      /* Instructions */
      .instructions {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(102, 126, 234, 0.08));
        border-left: 3px solid #8b5cf6;
        border-radius: 10px;
        padding: 16px;
        margin-top: 16px;
      }

      .instructions-title {
        font-size: 14px;
        font-weight: 700;
        color: #a78bfa;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .instructions-title::before {
        content: 'üí°';
        font-size: 16px;
      }

      .instructions-content {
        font-size: 13px;
        color: #d0d0d0;
        line-height: 1.8;
      }

      .instructions-content strong {
        color: #a78bfa;
      }

      /* Work Area Sections */
      .work-section {
        background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid rgba(139, 92, 246, 0.25);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
      }

      .work-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #8b5cf6, #667eea, #8b5cf6);
        background-size: 200% 100%;
        animation: shimmer 3s linear infinite;
      }

      .section-header {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        text-align: left;
      }

      .section-header::before {
        content: '';
        width: 3px;
        height: 20px;
        background: linear-gradient(135deg, #8b5cf6, #667eea);
        border-radius: 2px;
      }

      .demo-upload-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 12px;
      }

      @media (max-width: 1200px) {
        .demo-upload-layout {
          grid-template-columns: 1fr;
        }
      }

      .example-image-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .example-image-label {
        font-size: 13px;
        color: #a78bfa;
        font-weight: 600;
      }

      .example-image {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(139, 92, 246, 0.3);
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: all 0.2s ease-out;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .example-image:hover {
        border-color: rgba(139, 92, 246, 0.5);
        transform: scale(1.01);
      }

      .example-image img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        display: block;
        object-fit: contain;
      }

      .file-input-wrapper {
        position: relative;
        width: 100%;
        min-height: 200px;
        border-radius: 8px;
        border: 2px dashed rgba(139, 92, 246, 0.3);
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        transition: all 0.3s ease-out;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-input-wrapper:hover {
        border-color: rgba(139, 92, 246, 0.5);
        background: rgba(0, 0, 0, 0.4);
      }

      .file-input-wrapper.has-image {
        border-style: solid;
        border-color: rgba(139, 92, 246, 0.5);
        padding: 12px;
        height: 400px;
        align-items: flex-start;
      }

      .file-input-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        height: 100%;
        min-height: 160px;
        z-index: 10;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        cursor: pointer;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        background: rgba(0, 0, 0, 0.3);
      }

      .file-input-wrapper.has-image .file-input-display {
        display: none !important;
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
      }

      .file-input-button {
        padding: 10px 20px;
        border-radius: 8px;
        background: linear-gradient(135deg, #8b5cf6, #667eea);
        border: 1px solid rgba(139, 92, 246, 0.5);
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease-out;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        pointer-events: none;
      }

      .file-input-button::before {
        content: 'üì∑';
        font-size: 16px;
      }

      .file-input-name {
        font-size: 13px;
        color: #9ca3af;
        text-align: center;
        pointer-events: none;
      }

      .image-preview-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 5;
      }

      .file-input-wrapper.has-image .image-preview-container {
        display: flex;
      }

      .image-preview {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(139, 92, 246, 0.3);
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: all 0.2s ease-out;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        display: block;
        object-fit: contain;
        margin: 0 auto;
      }

      .image-preview:hover {
        border-color: rgba(139, 92, 246, 0.6);
        transform: scale(1.01);
      }

      .image-preview-close {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        z-index: 20;
        transition: all 0.2s ease-out;
      }

      .image-preview-close:hover {
        background: rgba(239, 68, 68, 0.9);
        border-color: rgba(239, 68, 68, 1);
      }

      /* Image Modal */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
      }

      .image-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-modal-content {
        max-width: 90%;
        max-height: 90%;
        position: relative;
      }

      .image-modal-content img {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 12px;
      }

      .image-modal-close {
        position: absolute;
        top: -40px;
        right: 0;
        color: #ffffff;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        background: rgba(139, 92, 246, 0.3);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .image-modal-close:hover {
        background: rgba(139, 92, 246, 0.6);
        transform: rotate(90deg);
      }

      /* Submit Bar */
      .submit-bar {
        margin: 32px auto 0;
        padding: 24px 0 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-top: 1px solid rgba(31, 41, 55, 0.9);
        max-width: 600px;
      }

      .submit-btn {
        padding: 14px 32px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 700;
        color: #ffffff;
        background: linear-gradient(135deg, #8b5cf6, #667eea);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        transition: all 0.2s ease-out;
      }

      .submit-btn:hover:not(.disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(139, 92, 246, 0.5);
      }

      .submit-btn:active:not(.disabled) {
        transform: translateY(0);
      }

      .submit-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="app-header">
        <div class="title-main">Knob Annotation Task</div>
        <div class="title-sub">Please follow the steps to complete the collection and annotation of knob images</div>
      </header>

      <!-- Guidelines Section -->
      <div class="guidelines-section">
        <div class="guidelines-title">Guidelines</div>

        <div class="guidelines-subsection">
          <div class="guidelines-subtitle">Task Description</div>
          <div class="guidelines-text">
            This task involves annotating appliance knobs from photos. You will upload a front-facing photo of a knob,
            draw a red rectangle around the knob's outer contour, mark the pointer position with a brown dot, and enter
            the scale value indicated by the pointer. Accurate annotations help build a high-quality dataset for knob
            recognition and analysis.
          </div>
        </div>

        <div class="guidelines-subsection">
          <div class="guidelines-subtitle">Requirements (Must Read)</div>
          <ul class="requirements-list">
            <li>Photo must clearly and completely contain the knob</li>
            <li>Non-AI generated photos only</li>
            <li>Must be front-facing view</li>
            <li>Each image must contain exactly one knob</li>
            <li>Knob must be centered in the photo</li>
            <li>Scale markings around the knob must be in Chinese, English, or numbers, not just icons</li>
          </ul>
        </div>
      </div>

      <div class="main-layout">
        <!-- Left Panel: Steps and Controls -->
        <div class="steps-panel">
          <div class="main-panel">
            <!-- Steps Title -->
            <h2 class="section-header" style="margin-top: 0">Task Steps</h2>
            <!-- Steps -->
            <div class="steps-container">
              <div class="step active" id="step1">
                <div class="step-header">
                  <div class="step-number">1</div>
                  <div class="step-title">Upload Knob Photo</div>
                </div>
                <div class="step-content">Please upload a clear front-facing photo of an appliance knob</div>
              </div>

              <div class="step" id="step2">
                <div class="step-header">
                  <div class="step-number">2</div>
                  <div class="step-title">Annotate Knob Outline</div>
                </div>
                <div class="step-content">
                  Use a red rectangle to annotate the knob's outer contour (do not only frame the pointer or include the
                  scale area)
                </div>
              </div>

              <div class="step" id="step3">
                <div class="step-header">
                  <div class="step-number">3</div>
                  <div class="step-title">Annotate Pointer Position</div>
                </div>
                <div class="step-content">
                  Use a brown dot to annotate the pointer position of the knob (click on the image to place the pointer
                  position)
                </div>
              </div>

              <div class="step" id="step4">
                <div class="step-header">
                  <div class="step-number">4</div>
                  <div class="step-title">Fill Scale Value</div>
                </div>
                <div class="step-content">Enter the text content of the scale value indicated by the pointer</div>
              </div>
            </div>

            <!-- Coordinates Display -->
            <div id="coordinatesDisplay" style="display: none; margin-top: 20px">
              <div class="coordinates-display">
                <div class="coordinate-item" id="rectCoords" style="display: none">
                  <span class="coordinate-label">Rectangle Coordinates:</span>
                  <span class="coordinate-value" id="rectCoordsValue">-</span>
                </div>
                <div class="coordinate-item" id="centerCoords" style="display: none">
                  <span class="coordinate-label">Center Point Coordinates:</span>
                  <span class="coordinate-value" id="centerCoordsValue">-</span>
                </div>
                <div class="coordinate-item" id="pointerCoords" style="display: none">
                  <span class="coordinate-label">Pointer Position Coordinates:</span>
                  <span class="coordinate-value" id="pointerCoordsValue">-</span>
                </div>
              </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage"></div>
          </div>
        </div>

        <!-- Right Panel: Image and Annotation Area -->
        <div class="work-area">
          <!-- Section 1: Upload Area -->
          <div class="work-section">
            <h2 class="section-header">Upload Image</h2>
            <div class="demo-upload-layout">
              <div class="example-image-section">
                <div class="example-image-label">Example: Original Image</div>
                <div class="example-image" onclick="showImageModal('images/raw.jpg')">
                  <img src="images/raw.jpg" alt="Example: Original Image" id="demoRawImage" />
                </div>
              </div>
              <div class="file-input-wrapper" id="uploadWrapper">
                <input type="file" id="imageInput" accept="image/*" style="display: none" />
                <div class="file-input-display" onclick="document.getElementById('imageInput').click();">
                  <span class="file-input-button">Upload Image</span>
                  <span class="file-input-name" id="uploadFileName">Supports JPG, PNG formats</span>
                </div>
                <div class="image-preview-container">
                  <div class="image-preview" id="uploadPreview">
                    <div class="image-preview-close" onclick="clearUploadImage()">√ó</div>
                    <img id="uploadPreviewImg" src="" alt="Preview" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 2: Annotation Area -->
          <div class="work-section">
            <h2 class="section-header">Image Annotation</h2>
            <div class="demo-upload-layout">
              <div class="example-image-section">
                <div class="example-image-label">Example: Annotated Image</div>
                <div class="example-image" onclick="showImageModal('images/label.png')">
                  <img src="images/label.png" alt="Example: Annotated Image" id="demoLabelImage" />
                </div>
              </div>
              <div>
                <div id="canvasWrapper" style="display: none">
                  <div class="canvas-container">
                    <canvas id="annotationCanvas"></canvas>
                  </div>
                  <div class="canvas-controls" style="margin-top: 16px">
                    <button class="btn btn-secondary" id="clearRectBtn" disabled>Clear Rectangle</button>
                    <button class="btn btn-secondary" id="clearPointerBtn" disabled>Clear Pointer</button>
                  </div>
                </div>
                <div id="canvasPlaceholder" style="text-align: center; padding: 60px 20px; color: #888888">
                  <div style="font-size: 48px; margin-bottom: 16px">üì∑</div>
                  <div>Please upload an image first</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 3: Scale Value Input -->
          <div class="work-section">
            <h2 class="section-header">Fill Scale Value</h2>
            <div id="scaleInputWrapper">
              <div class="input-group">
                <label class="input-label">Scale Value Indicated by Pointer</label>
                <input type="text" class="input-field" id="scaleValueInput" placeholder="e.g., 60 min" disabled />
              </div>
            </div>
            <div
              id="scaleInputPlaceholder"
              style="display: none; text-align: center; padding: 40px 20px; color: #888888"
            >
              <div>Please complete pointer position annotation first</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="submit-bar">
        <button class="submit-btn disabled" id="submitBtn" type="button">Submit Task</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
      <div class="image-modal-content">
        <span class="image-modal-close" id="closeImageModal">&times;</span>
        <img id="modalImage" src="" alt="Enlarged Image" />
      </div>
    </div>

    <script>
      // State management
      const state = {
        currentStep: 1,
        image: null,
        imageFile: null,
        rect: null,
        pointer: null,
        scaleValue: '',
        isDrawingRect: false,
        rectStart: null,
        justFinishedDrawing: false,
        // ÊãñÂä®ÂíåË∞ÉÊï¥Áõ∏ÂÖ≥
        isDraggingRect: false,
        isResizingRect: false,
        isDraggingPointer: false,
        dragStart: null,
        resizeHandle: null,
        rectOffset: null,
        // CanvasÊòæÁ§∫Â∞∫ÂØ∏ÔºàÁî®‰∫éÂùêÊ†áËÆ°ÁÆóÔºâ
        canvasDisplayWidth: null,
        canvasDisplayHeight: null
      }

      // DOM elements
      const uploadWrapper = document.getElementById('uploadWrapper')
      const imageInput = document.getElementById('imageInput')
      const uploadFileName = document.getElementById('uploadFileName')
      const uploadPreview = document.getElementById('uploadPreview')
      const uploadPreviewImg = document.getElementById('uploadPreviewImg')
      const canvasWrapper = document.getElementById('canvasWrapper')
      const canvasPlaceholder = document.getElementById('canvasPlaceholder')
      const canvas = document.getElementById('annotationCanvas')
      const ctx = canvas.getContext('2d')
      const clearRectBtn = document.getElementById('clearRectBtn')
      const clearPointerBtn = document.getElementById('clearPointerBtn')
      const coordinatesDisplay = document.getElementById('coordinatesDisplay')
      const scaleInputWrapper = document.getElementById('scaleInputWrapper')
      const scaleInputPlaceholder = document.getElementById('scaleInputPlaceholder')
      const scaleValueInput = document.getElementById('scaleValueInput')
      const submitBtn = document.getElementById('submitBtn')
      const statusMessage = document.getElementById('statusMessage')
      const imageModal = document.getElementById('imageModal')
      const modalImage = document.getElementById('modalImage')
      const closeImageModal = document.getElementById('closeImageModal')
      const demoRawImage = document.getElementById('demoRawImage')
      const demoLabelImage = document.getElementById('demoLabelImage')

      // Initialize
      uploadWrapper.addEventListener('dragover', handleDragOver)
      uploadWrapper.addEventListener('drop', handleDrop)
      imageInput.addEventListener('change', handleImageSelect)
      uploadPreviewImg.addEventListener('click', () => showImageModal(uploadPreviewImg.src))
      demoRawImage.addEventListener('click', () => showImageModal(demoRawImage.src))
      demoLabelImage.addEventListener('click', () => showImageModal(demoLabelImage.src))
      closeImageModal.addEventListener('click', () => hideImageModal())
      imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
          hideImageModal()
        }
      })
      clearRectBtn.addEventListener('click', clearRect)
      clearPointerBtn.addEventListener('click', clearPointer)
      scaleValueInput.addEventListener('input', handleScaleValueInput)
      submitBtn.addEventListener('click', handleSubmit)

      // Canvas event listeners
      canvas.addEventListener('mousedown', handleCanvasMouseDown)
      canvas.addEventListener('mousemove', handleCanvasMouseMove)
      canvas.addEventListener('mouseup', handleCanvasMouseUp)
      canvas.addEventListener('click', handleCanvasClick)

      function handleDragOver(e) {
        e.preventDefault()
        e.stopPropagation()
      }

      function handleDrop(e) {
        e.preventDefault()
        e.stopPropagation()
        const files = e.dataTransfer.files
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          loadImage(files[0])
        }
      }

      function handleImageSelect(e) {
        const file = e.target.files[0]
        if (file) {
          loadImage(file)
        }
      }

      function loadImage(file) {
        const reader = new FileReader()
        reader.onload = (e) => {
          const img = new Image()
          img.onload = () => {
            state.image = img
            state.imageFile = file
            const imageDataUrl = e.target.result

            // Update upload preview
            uploadPreviewImg.src = imageDataUrl
            uploadWrapper.classList.add('has-image')
            uploadFileName.textContent = file.name || 'Image uploaded'

            // Setup canvas for annotation
            canvasPlaceholder.style.display = 'none'
            canvasWrapper.style.display = 'block'

            // Á≠âÂæÖ DOM Êõ¥Êñ∞ÂêéÂÜçËÆæÁΩÆ canvas
            setTimeout(() => {
              setupCanvas(img)
            }, 0)

            updateStep(1, true)
            updateStep(2, false)
          }
          img.src = e.target.result
        }
        reader.readAsDataURL(file)
      }

      function clearUploadImage() {
        if (
          confirm('Are you sure you want to delete the current image and re-upload? All annotations will be cleared.')
        ) {
          handleDeleteImage({ stopPropagation: () => {} })
        }
      }

      function showImageModal(imageSrc) {
        modalImage.src = imageSrc
        imageModal.classList.add('active')
        document.body.style.overflow = 'hidden'
      }

      function hideImageModal() {
        imageModal.classList.remove('active')
        document.body.style.overflow = ''
      }

      function handleDeleteImage(e) {
        if (e && e.stopPropagation) {
          e.stopPropagation()
        }

        // Reset all state
        state.image = null
        state.imageFile = null
        state.rect = null
        state.pointer = null
        state.scaleValue = ''
        state.currentStep = 1

        // Reset UI
        uploadWrapper.classList.remove('has-image')
        uploadPreviewImg.src = ''
        uploadFileName.textContent = 'Supports JPG, PNG formats'
        canvasPlaceholder.style.display = 'block'
        canvasWrapper.style.display = 'none'
        coordinatesDisplay.style.display = 'none'
        scaleValueInput.disabled = true
        scaleValueInput.value = ''
        scaleValueInput.value = ''
        imageInput.value = ''

        // Reset steps
        updateStep(1, false)
        updateStep(2, false)
        updateStep(3, false)
        updateStep(4, false)

        // Reset buttons
        clearRectBtn.disabled = true
        clearPointerBtn.disabled = true
        submitBtn.disabled = true
      }

      function setupCanvas(img) {
        if (!img) return

        // ÂÆπÂô®Âõ∫ÂÆöÈ´òÂ∫¶‰∏∫ 400pxÔºåÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫î
        const containerHeight = 400
        const container = canvas.parentElement

        // Ëé∑ÂèñÂÆπÂô®ÂÆûÈôÖÂÆΩÂ∫¶ÔºåÂ¶ÇÊûúËé∑Âèñ‰∏çÂà∞Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº
        let containerWidth = container.clientWidth || container.offsetWidth
        if (!containerWidth || containerWidth === 0) {
          // Â¶ÇÊûúÂÆπÂô®ÂÆΩÂ∫¶‰∏∫0Ôºå‰ΩøÁî®ÂõæÁâáÂéüÂßãÂÆΩÂ∫¶ÊàñÈªòËÆ§ÂÄº
          containerWidth = Math.min(img.width, 800)
        }

        // ËÆ°ÁÆóÈÄÇÈÖçÂÆπÂô®ÁöÑÊòæÁ§∫Â∞∫ÂØ∏Ôºå‰øùÊåÅÂõæÁâáÂÆΩÈ´òÊØî
        const imgRatio = img.width / img.height
        const containerRatio = containerWidth / containerHeight

        let displayWidth, displayHeight
        if (imgRatio > containerRatio) {
          // ÂõæÁâáÊõ¥ÂÆΩÔºå‰ª•ÂÆΩÂ∫¶‰∏∫ÂáÜ
          displayWidth = containerWidth
          displayHeight = containerWidth / imgRatio
        } else {
          // ÂõæÁâáÊõ¥È´òÔºå‰ª•È´òÂ∫¶‰∏∫ÂáÜ
          displayHeight = containerHeight
          displayWidth = containerHeight * imgRatio
        }

        // Á°Æ‰øù‰∏çË∂ÖËøáÂÆπÂô®Â§ßÂ∞è
        displayWidth = Math.min(displayWidth, containerWidth)
        displayHeight = Math.min(displayHeight, containerHeight)

        // Á°Æ‰øùÂ∞∫ÂØ∏Ëá≥Â∞ë‰∏∫1
        displayWidth = Math.max(displayWidth, 1)
        displayHeight = Math.max(displayHeight, 1)

        // Ëé∑ÂèñËÆæÂ§áÂÉèÁ¥†ÊØîÔºåÊèêÈ´òÊ∏ÖÊô∞Â∫¶
        const dpr = window.devicePixelRatio || 1

        // ËÆæÁΩÆCanvasÁöÑÊòæÁ§∫Â∞∫ÂØ∏ÔºàCSSÂ∞∫ÂØ∏Ôºâ
        canvas.style.width = displayWidth + 'px'
        canvas.style.height = displayHeight + 'px'

        // ËÆæÁΩÆCanvasÁöÑÂÆûÈôÖÁªòÂà∂Â∞∫ÂØ∏ÔºàËÄÉËôëËÆæÂ§áÂÉèÁ¥†ÊØîÔºåÊèêÈ´òÊ∏ÖÊô∞Â∫¶Ôºâ
        canvas.width = displayWidth * dpr
        canvas.height = displayHeight * dpr

        // Áº©Êîæcontext‰ª•ÂåπÈÖçËÆæÂ§áÂÉèÁ¥†ÊØî
        ctx.scale(dpr, dpr)

        // ËÆæÁΩÆÈ´òË¥®ÈáèÂõæÁâáÊ∏≤Êüì
        ctx.imageSmoothingEnabled = true
        ctx.imageSmoothingQuality = 'high'

        // ÁªòÂà∂ÂõæÁâáÔºà‰ΩøÁî®ÊòæÁ§∫Â∞∫ÂØ∏ÔºåÂõ†‰∏∫contextÂ∑≤ÁªèÁº©ÊîæÔºâ
        ctx.drawImage(img, 0, 0, displayWidth, displayHeight)

        // ‰øùÂ≠òÊòæÁ§∫Â∞∫ÂØ∏Âà∞stateÔºåÁî®‰∫éÂùêÊ†áËÆ°ÁÆó
        state.canvasDisplayWidth = displayWidth
        state.canvasDisplayHeight = displayHeight
      }

      function getCanvasCoordinates(e) {
        const rect = canvas.getBoundingClientRect()
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        }
      }

      function isPointInRect(x, y, rect) {
        return x >= rect.x1 && x <= rect.x2 && y >= rect.y1 && y <= rect.y2
      }

      function isPointNearPoint(x1, y1, x2, y2, threshold = 10) {
        return Math.abs(x1 - x2) < threshold && Math.abs(y1 - y2) < threshold
      }

      function getResizeHandle(x, y, rect) {
        const threshold = 10
        // Ê£ÄÊü•ÊòØÂê¶Âú®Áü©ÂΩ¢ÁöÑËæπÁºòÊàñËßíËêΩ
        const handles = [
          { name: 'nw', x: rect.x1, y: rect.y1 }, // Â∑¶‰∏ä
          { name: 'ne', x: rect.x2, y: rect.y1 }, // Âè≥‰∏ä
          { name: 'sw', x: rect.x1, y: rect.y2 }, // Â∑¶‰∏ã
          { name: 'se', x: rect.x2, y: rect.y2 }, // Âè≥‰∏ã
          { name: 'n', x: (rect.x1 + rect.x2) / 2, y: rect.y1 }, // ‰∏ä
          { name: 's', x: (rect.x1 + rect.x2) / 2, y: rect.y2 }, // ‰∏ã
          { name: 'w', x: rect.x1, y: (rect.y1 + rect.y2) / 2 }, // Â∑¶
          { name: 'e', x: rect.x2, y: (rect.y1 + rect.y2) / 2 } // Âè≥
        ]

        for (const handle of handles) {
          if (isPointNearPoint(x, y, handle.x, handle.y, threshold)) {
            return handle.name
          }
        }
        return null
      }

      function handleCanvasMouseDown(e) {
        const pos = getCanvasCoordinates(e)
        const x = pos.x
        const y = pos.y

        // Â¶ÇÊûúÂ∑≤ÊúâÁü©ÂΩ¢Ê°ÜÔºåÊ£ÄÊü•ÊòØÂê¶Âú®ÊãñÂä®ÊàñË∞ÉÊï¥Â§ßÂ∞è
        if (state.rect) {
          const handle = getResizeHandle(x, y, state.rect)
          if (handle) {
            // Ë∞ÉÊï¥Â§ßÂ∞è
            state.isResizingRect = true
            state.resizeHandle = handle
            state.rectStart = { x: state.rect.x1, y: state.rect.y1, x2: state.rect.x2, y2: state.rect.y2 }
            e.preventDefault()
            return
          } else if (isPointInRect(x, y, state.rect)) {
            // ÊãñÂä®Áü©ÂΩ¢
            state.isDraggingRect = true
            state.rectOffset = { x: x - state.rect.x1, y: y - state.rect.y1 }
            e.preventDefault()
            return
          }
        }

        // Â¶ÇÊûúÂ∑≤ÊúâÊåáÈíàÁÇπÔºåÊ£ÄÊü•ÊòØÂê¶Âú®ÊãñÂä®
        if (state.pointer) {
          if (isPointNearPoint(x, y, state.pointer.x, state.pointer.y, 10)) {
            state.isDraggingPointer = true
            e.preventDefault()
            return
          }
        }

        // ÁªòÂà∂Êñ∞Áü©ÂΩ¢Ê°ÜÔºàStep 2Ôºâ
        if (state.currentStep === 2 || (state.currentStep > 2 && !state.rect)) {
          state.isDrawingRect = true
          state.rectStart = { x, y }
        }
      }

      function handleCanvasMouseMove(e) {
        const pos = getCanvasCoordinates(e)
        const x = pos.x
        const y = pos.y

        // Ë∞ÉÊï¥Áü©ÂΩ¢Â§ßÂ∞è
        if (state.isResizingRect && state.rect) {
          const start = state.rectStart
          let newRect = { ...state.rect }

          switch (state.resizeHandle) {
            case 'nw':
              newRect.x1 = x
              newRect.y1 = y
              break
            case 'ne':
              newRect.x2 = x
              newRect.y1 = y
              break
            case 'sw':
              newRect.x1 = x
              newRect.y2 = y
              break
            case 'se':
              newRect.x2 = x
              newRect.y2 = y
              break
            case 'n':
              newRect.y1 = y
              break
            case 's':
              newRect.y2 = y
              break
            case 'w':
              newRect.x1 = x
              break
            case 'e':
              newRect.x2 = x
              break
          }

          // Á°Æ‰øùÂùêÊ†áÊ≠£Á°Æ
          if (newRect.x1 > newRect.x2) [newRect.x1, newRect.x2] = [newRect.x2, newRect.x1]
          if (newRect.y1 > newRect.y2) [newRect.y1, newRect.y2] = [newRect.y2, newRect.y1]

          newRect.x3 = newRect.x2
          newRect.y3 = newRect.y1
          newRect.x4 = newRect.x1
          newRect.y4 = newRect.y2

          state.rect = newRect
          calculateCenter()
          redrawCanvas()
          updateCoordinatesDisplay()
          return
        }

        // ÊãñÂä®Áü©ÂΩ¢
        if (state.isDraggingRect && state.rect) {
          const offset = state.rectOffset
          const width = state.rect.x2 - state.rect.x1
          const height = state.rect.y2 - state.rect.y1

          state.rect.x1 = x - offset.x
          state.rect.y1 = y - offset.y
          state.rect.x2 = state.rect.x1 + width
          state.rect.y2 = state.rect.y1 + height
          state.rect.x3 = state.rect.x2
          state.rect.y3 = state.rect.y1
          state.rect.x4 = state.rect.x1
          state.rect.y4 = state.rect.y2

          calculateCenter()
          redrawCanvas()
          updateCoordinatesDisplay()
          return
        }

        // ÊãñÂä®ÊåáÈíàÁÇπ
        if (state.isDraggingPointer && state.pointer) {
          state.pointer.x = x
          state.pointer.y = y
          redrawCanvas()
          updateCoordinatesDisplay()
          return
        }

        // ÁªòÂà∂Êñ∞Áü©ÂΩ¢Ê°Ü
        if (state.isDrawingRect) {
          redrawCanvas()

          // Draw temporary rectangle
          ctx.strokeStyle = '#ef4444'
          ctx.lineWidth = 2
          ctx.setLineDash([5, 5])
          ctx.strokeRect(state.rectStart.x, state.rectStart.y, x - state.rectStart.x, y - state.rectStart.y)
          ctx.setLineDash([])
          return
        }

        // Êõ¥Êñ∞Èº†Ê†áÊ†∑Âºè
        updateCursor(x, y)
      }

      function updateCursor(x, y) {
        if (state.rect) {
          const handle = getResizeHandle(x, y, state.rect)
          if (handle) {
            const cursors = {
              nw: 'nw-resize',
              ne: 'ne-resize',
              sw: 'sw-resize',
              se: 'se-resize',
              n: 'n-resize',
              s: 's-resize',
              w: 'w-resize',
              e: 'e-resize'
            }
            canvas.style.cursor = cursors[handle]
            return
          } else if (isPointInRect(x, y, state.rect)) {
            canvas.style.cursor = 'move'
            return
          }
        }

        if (state.pointer && isPointNearPoint(x, y, state.pointer.x, state.pointer.y, 10)) {
          canvas.style.cursor = 'move'
          return
        }

        if (state.currentStep === 2 || (state.currentStep > 2 && !state.rect)) {
          // ÁªòÂà∂Áü©ÂΩ¢Ê°ÜÊó∂‰ΩøÁî® crosshair
          canvas.style.cursor = 'crosshair'
        } else if (state.currentStep === 3 || (state.currentStep > 3 && !state.pointer)) {
          // Ê†áÊ≥®ÊåáÈíà‰ΩçÁΩÆÊó∂‰ΩøÁî® pointerÔºåÂå∫Âà´‰∫éÁü©ÂΩ¢Ê°Ü
          canvas.style.cursor = 'pointer'
        } else {
          canvas.style.cursor = 'default'
        }
      }

      function handleCanvasMouseUp(e) {
        // Ë∞ÉÊï¥Áü©ÂΩ¢Â§ßÂ∞èÂÆåÊàê
        if (state.isResizingRect) {
          state.isResizingRect = false
          state.resizeHandle = null
          state.rectStart = null
          e.preventDefault()
          e.stopPropagation()
          return
        }

        // ÊãñÂä®Áü©ÂΩ¢ÂÆåÊàê
        if (state.isDraggingRect) {
          state.isDraggingRect = false
          state.rectOffset = null
          e.preventDefault()
          e.stopPropagation()
          return
        }

        // ÊãñÂä®ÊåáÈíàÂÆåÊàê
        if (state.isDraggingPointer) {
          state.isDraggingPointer = false
          e.preventDefault()
          e.stopPropagation()
          return
        }

        // ÁªòÂà∂Êñ∞Áü©ÂΩ¢Ê°ÜÂÆåÊàê
        if (state.isDrawingRect) {
          // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈò≤Ê≠¢Ëß¶Âèëclick‰∫ã‰ª∂
          e.preventDefault()
          e.stopPropagation()

          const pos = getCanvasCoordinates(e)
          const x = pos.x
          const y = pos.y

          const x1 = Math.min(state.rectStart.x, x)
          const y1 = Math.min(state.rectStart.y, y)
          const x2 = Math.max(state.rectStart.x, x)
          const y2 = Math.max(state.rectStart.y, y)

          if (Math.abs(x2 - x1) > 10 && Math.abs(y2 - y1) > 10) {
            state.rect = {
              x1,
              y1,
              x2,
              y2,
              x3: x2,
              y3: y1,
              x4: x1,
              y4: y2
            }

            calculateCenter()
            redrawCanvas()
            updateStep(2, true)
            updateStep(3, false)
            clearRectBtn.disabled = false
            updateCoordinatesDisplay()
            checkSubmitButton()
          }

          state.isDrawingRect = false
          state.rectStart = null

          // ËÆæÁΩÆ‰∏Ä‰∏™Ê†áËÆ∞ÔºåÈò≤Ê≠¢mouseupÂêéÁ´ãÂç≥Ëß¶Âèëclick
          state.justFinishedDrawing = true
          setTimeout(() => {
            state.justFinishedDrawing = false
          }, 200)
        }
      }

      function handleCanvasClick(e) {
        // Âè™ÊúâÂú®Step 3‰∏î‰∏çÊòØÂàöÂÆåÊàêÁªòÂà∂Áü©ÂΩ¢Ê°ÜÊó∂ÊâçÂÖÅËÆ∏ÁÇπÂáªÊ†áÊ≥®ÊåáÈíà
        if (state.currentStep !== 3) return
        if (state.justFinishedDrawing) return
        if (state.isDrawingRect) return

        const rect = canvas.getBoundingClientRect()
        const x = e.clientX - rect.left
        const y = e.clientY - rect.top

        state.pointer = { x, y }
        redrawCanvas()
        updateStep(3, true)
        updateStep(4, false)
        clearPointerBtn.disabled = false
        updateCoordinatesDisplay()
        // ÂêØÁî®ÂàªÂ∫¶ÂÄºËæìÂÖ•Ê°Ü
        scaleValueInput.disabled = false
        checkSubmitButton()
      }

      function redrawCanvas() {
        if (!state.image) return

        // Ëé∑ÂèñÊòæÁ§∫Â∞∫ÂØ∏ÔºàËÄÉËôëËÆæÂ§áÂÉèÁ¥†ÊØîÔºâ
        const dpr = window.devicePixelRatio || 1
        const displayWidth = state.canvasDisplayWidth || canvas.width / dpr
        const displayHeight = state.canvasDisplayHeight || canvas.height / dpr

        // Ê∏ÖÈô§CanvasÔºà‰ΩøÁî®ÂÆûÈôÖÂ∞∫ÂØ∏Ôºâ
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        // ÁªòÂà∂ÂõæÁâáÔºà‰ΩøÁî®ÊòæÁ§∫Â∞∫ÂØ∏ÔºåÂõ†‰∏∫contextÂ∑≤ÁªèÁº©ÊîæÔºâ
        ctx.drawImage(state.image, 0, 0, displayWidth, displayHeight)

        // Draw rectangle
        if (state.rect) {
          ctx.strokeStyle = '#ef4444'
          ctx.lineWidth = 3
          ctx.strokeRect(state.rect.x1, state.rect.y1, state.rect.x2 - state.rect.x1, state.rect.y2 - state.rect.y1)

          // Draw center point
          if (state.rect.center) {
            ctx.fillStyle = '#22c55e'
            ctx.beginPath()
            ctx.arc(state.rect.center.x, state.rect.center.y, 5, 0, Math.PI * 2)
            ctx.fill()
          }

          // ÁªòÂà∂Ë∞ÉÊï¥Â§ßÂ∞èÁöÑÊéßÂà∂ÁÇπÔºà‰ªÖÂú®Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Ôºâ
          if (!state.isDrawingRect && !state.isDraggingRect && !state.isResizingRect) {
            const handles = [
              { x: state.rect.x1, y: state.rect.y1 },
              { x: state.rect.x2, y: state.rect.y1 },
              { x: state.rect.x1, y: state.rect.y2 },
              { x: state.rect.x2, y: state.rect.y2 }
            ]

            ctx.fillStyle = '#ef4444'
            handles.forEach((handle) => {
              ctx.beginPath()
              ctx.arc(handle.x, handle.y, 4, 0, Math.PI * 2)
              ctx.fill()
            })
          }
        }

        // ÊúÄÂêéÁªòÂà∂ÊåáÈíàÁÇπÔºà‰∏äÂ±ÇÔºâÔºåÁ°Æ‰øùÁÇπÂú®Áü©ÂΩ¢Ê°Ü‰πã‰∏ä
        if (state.pointer) {
          ctx.fillStyle = '#a16207'
          ctx.beginPath()
          ctx.arc(state.pointer.x, state.pointer.y, 6, 0, Math.PI * 2)
          ctx.fill()
          ctx.strokeStyle = '#ffffff'
          ctx.lineWidth = 2
          ctx.stroke()
        }
      }

      function calculateCenter() {
        if (!state.rect) return

        const centerX = (state.rect.x1 + state.rect.x2) / 2
        const centerY = (state.rect.y1 + state.rect.y2) / 2

        state.rect.center = { x: centerX, y: centerY }

        updateCoordinatesDisplay()
      }

      function updateCoordinatesDisplay() {
        coordinatesDisplay.style.display = 'block'

        if (state.rect) {
          document.getElementById('rectCoords').style.display = 'block'
          document.getElementById('rectCoordsValue').textContent =
            `<${Math.round(state.rect.x1)},${Math.round(state.rect.y1)}>, ` +
            `<${Math.round(state.rect.x2)},${Math.round(state.rect.y2)}>, ` +
            `<${Math.round(state.rect.x3)},${Math.round(state.rect.y3)}>, ` +
            `<${Math.round(state.rect.x4)},${Math.round(state.rect.y4)}>`

          if (state.rect.center) {
            document.getElementById('centerCoords').style.display = 'block'
            document.getElementById('centerCoordsValue').textContent =
              `<${Math.round(state.rect.center.x)},${Math.round(state.rect.center.y)}>`
          }
        }

        if (state.pointer) {
          document.getElementById('pointerCoords').style.display = 'block'
          document.getElementById('pointerCoordsValue').textContent =
            `<${Math.round(state.pointer.x)},${Math.round(state.pointer.y)}>`
        }
      }

      function clearRect() {
        state.rect = null
        redrawCanvas()
        document.getElementById('rectCoords').style.display = 'none'
        document.getElementById('centerCoords').style.display = 'none'
        clearRectBtn.disabled = true
        // Ê∏ÖÈô§ÂêéÈáçÊñ∞ÊøÄÊ¥ªStep 2ÔºåÂÖÅËÆ∏ÈáçÊñ∞Ê†áÊ≥®
        updateStep(2, false)
        state.currentStep = 2
        const step2El = document.getElementById('step2')
        step2El.classList.add('active')
      }

      function clearPointer() {
        state.pointer = null
        state.scaleValue = ''
        scaleValueInput.value = ''
        redrawCanvas()
        document.getElementById('pointerCoords').style.display = 'none'
        clearPointerBtn.disabled = true
        // Ê∏ÖÈô§ÂêéÈáçÊñ∞ÊøÄÊ¥ªStep 3ÔºåÂÖÅËÆ∏ÈáçÊñ∞Ê†áÊ≥®
        updateStep(3, false)
        updateStep(4, false)
        state.currentStep = 3
        const step3El = document.getElementById('step3')
        step3El.classList.add('active')
        scaleValueInput.disabled = true
        scaleValueInput.value = ''
        checkSubmitButton()
      }

      function handleScaleValueInput(e) {
        state.scaleValue = e.target.value.trim()
        if (state.scaleValue) {
          updateStep(4, true)
        } else {
          updateStep(4, false)
        }
        checkSubmitButton()
      }

      function updateStep(stepNum, completed) {
        const stepEl = document.getElementById(`step${stepNum}`)
        if (completed) {
          stepEl.classList.add('completed')
          stepEl.classList.remove('active')
          if (stepNum < 4) {
            state.currentStep = stepNum + 1
            const nextStepEl = document.getElementById(`step${stepNum + 1}`)
            if (nextStepEl) {
              nextStepEl.classList.add('active')
            }
          } else if (stepNum === 4) {
            state.currentStep = 4
          }
        } else {
          stepEl.classList.remove('completed', 'active')
          if (stepNum === state.currentStep) {
            stepEl.classList.add('active')
          }
        }

        // Enable/disable input based on step
        // ÂΩìStep 3ÂÆåÊàêËøõÂÖ•Step 4Êó∂ÔºåÊàñËÄÖÂΩìÂâçÂú®Step 4Êó∂ÔºåÂêØÁî®ËæìÂÖ•Ê°Ü
        if (state.currentStep >= 4 && state.pointer) {
          scaleValueInput.disabled = false
        } else {
          scaleValueInput.disabled = true
        }
      }

      function checkSubmitButton() {
        const canSubmit = state.image && state.rect && state.rect.center && state.pointer && state.scaleValue
        submitBtn.disabled = !canSubmit
        if (canSubmit) {
          submitBtn.classList.remove('disabled')
        } else {
          submitBtn.classList.add('disabled')
        }
      }

      function handleSubmit() {
        if (!state.image || !state.rect || !state.rect.center || !state.pointer || !state.scaleValue) {
          showStatus('Please complete all steps before submitting', 'error')
          return
        }

        // Prepare submission data
        const submissionData = {
          originalImage: canvas.toDataURL('image/png'),
          annotatedImage: canvas.toDataURL('image/png'),
          rectCoordinates: {
            x1: Math.round(state.rect.x1),
            y1: Math.round(state.rect.y1),
            x2: Math.round(state.rect.x2),
            y2: Math.round(state.rect.y2),
            x3: Math.round(state.rect.x3),
            y3: Math.round(state.rect.y3),
            x4: Math.round(state.rect.x4),
            y4: Math.round(state.rect.y4)
          },
          centerCoordinates: {
            x: Math.round(state.rect.center.x),
            y: Math.round(state.rect.center.y)
          },
          pointerCoordinates: {
            x: Math.round(state.pointer.x),
            y: Math.round(state.pointer.y)
          },
          scaleValue: state.scaleValue
        }

        // Log submission data (in production, this would be sent to a server)
        console.log('Submission Data:', submissionData)

        showStatus('Task submitted successfully! Data has been saved.', 'success')

        // Reset after 3 seconds
        setTimeout(() => {
          if (confirm('Submission successful! Would you like to start a new annotation task?')) {
            location.reload()
          }
        }, 3000)
      }

      function showStatus(message, type) {
        statusMessage.textContent = message
        statusMessage.className = `status-message ${type}`
        setTimeout(() => {
          statusMessage.className = 'status-message'
        }, 5000)
      }

      // Input is always visible, but disabled until pointer is annotated
    </script>
  </body>
</html>
